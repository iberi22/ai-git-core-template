name: Process Telemetry Submissions

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'telemetry/submissions/**'
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: read

jobs:
  validate-telemetry:
    name: ðŸ” Validate Submission
    runs-on: ubuntu-latest
    outputs:
      valid: ${{ steps.validate.outputs.valid }}
      project_id: ${{ steps.validate.outputs.project_id }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: files
        run: |
          FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep '^telemetry/submissions/.*\.json$' || true)
          echo "files=$FILES" >> $GITHUB_OUTPUT
          echo "Found telemetry files: $FILES"

      - name: Validate JSON schema
        id: validate
        run: |
          VALID=true
          PROJECT_ID=""

          for file in ${{ steps.files.outputs.files }}; do
            if [ -f "$file" ]; then
              echo "Validating: $file"

              # Check JSON is valid
              if ! jq empty "$file" 2>/dev/null; then
                echo "âŒ Invalid JSON in $file"
                VALID=false
                continue
              fi

              # Check required fields
              SCHEMA_VERSION=$(jq -r '.schema_version // empty' "$file")
              PROJECT=$(jq -r '.project_id // empty' "$file")
              TIMESTAMP=$(jq -r '.timestamp // empty' "$file")

              if [ -z "$SCHEMA_VERSION" ] || [ -z "$PROJECT" ] || [ -z "$TIMESTAMP" ]; then
                echo "âŒ Missing required fields in $file"
                VALID=false
                continue
              fi

              PROJECT_ID="$PROJECT"
              echo "âœ… Valid: $file (project: $PROJECT_ID)"
            fi
          done

          echo "valid=$VALID" >> $GITHUB_OUTPUT
          echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT

      - name: Comment validation result
        uses: actions/github-script@v7
        with:
          script: |
            const valid = '${{ steps.validate.outputs.valid }}' === 'true';
            const projectId = '${{ steps.validate.outputs.project_id }}';

            const body = valid
              ? `## âœ… Telemetry Validated\n\n**Project:** \`${projectId}\`\n\nThis submission passed schema validation and will be included in the next analysis cycle.\n\n---\n*Auto-validated by Telemetry Processor*`
              : `## âŒ Validation Failed\n\nThe telemetry submission has issues. Please ensure:\n- JSON is valid\n- Required fields: \`schema_version\`, \`project_id\`, \`timestamp\`\n\n---\n*Auto-validated by Telemetry Processor*`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  aggregate-metrics:
    name: ðŸ“Š Aggregate Metrics
    runs-on: ubuntu-latest
    needs: validate-telemetry
    if: needs.validate-telemetry.outputs.valid == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Aggregate all telemetry
        id: aggregate
        run: |
          # Combine all telemetry files
          echo "Aggregating telemetry from all submissions..."

          TOTAL_PROJECTS=0
          TOTAL_ISSUES_CLOSED=0
          TOTAL_PRS_MERGED=0
          AVG_AGENT_STATE=0
          AVG_ATOMIC_RATIO=0
          TOTAL_FRICTION=0
          TOTAL_EVOLUTION=0

          for file in telemetry/submissions/*.json; do
            if [ -f "$file" ]; then
              TOTAL_PROJECTS=$((TOTAL_PROJECTS + 1))

              ISSUES=$(jq -r '.order1.issues_closed_total // 0' "$file")
              PRS=$(jq -r '.order1.prs_merged_total // 0' "$file")
              AGENT=$(jq -r '.order2.agent_state_usage_pct // 0' "$file")
              ATOMIC=$(jq -r '.order2.atomic_commit_ratio // 0' "$file")
              FRICTION=$(jq -r '.order3.friction_reports // 0' "$file")
              EVOLUTION=$(jq -r '.order3.evolution_proposals // 0' "$file")

              TOTAL_ISSUES_CLOSED=$((TOTAL_ISSUES_CLOSED + ISSUES))
              TOTAL_PRS_MERGED=$((TOTAL_PRS_MERGED + PRS))
              AVG_AGENT_STATE=$((AVG_AGENT_STATE + AGENT))
              AVG_ATOMIC_RATIO=$((AVG_ATOMIC_RATIO + ATOMIC))
              TOTAL_FRICTION=$((TOTAL_FRICTION + FRICTION))
              TOTAL_EVOLUTION=$((TOTAL_EVOLUTION + EVOLUTION))
            fi
          done

          if [ $TOTAL_PROJECTS -gt 0 ]; then
            AVG_AGENT_STATE=$((AVG_AGENT_STATE / TOTAL_PROJECTS))
            AVG_ATOMIC_RATIO=$((AVG_ATOMIC_RATIO / TOTAL_PROJECTS))
          fi

          echo "=== Aggregate Results ==="
          echo "Total Projects: $TOTAL_PROJECTS"
          echo "Total Issues Closed: $TOTAL_ISSUES_CLOSED"
          echo "Total PRs Merged: $TOTAL_PRS_MERGED"
          echo "Avg Agent-State Usage: $AVG_AGENT_STATE%"
          echo "Avg Atomic Commit Ratio: $AVG_ATOMIC_RATIO%"
          echo "Total Friction Reports: $TOTAL_FRICTION"
          echo "Total Evolution Proposals: $TOTAL_EVOLUTION"

          # Output for next steps
          echo "total_projects=$TOTAL_PROJECTS" >> $GITHUB_OUTPUT
          echo "avg_agent_state=$AVG_AGENT_STATE" >> $GITHUB_OUTPUT
          echo "avg_atomic_ratio=$AVG_ATOMIC_RATIO" >> $GITHUB_OUTPUT
          echo "total_friction=$TOTAL_FRICTION" >> $GITHUB_OUTPUT

      - name: Update aggregate dashboard
        run: |
          # This could update a dashboard file or create an issue
          echo "Aggregate metrics updated. See workflow logs for details."
