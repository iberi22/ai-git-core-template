name: ğŸ§  Context Research Agent

on:
  # Weekly scheduled run
  schedule:
    - cron: '0 8 * * 1' # Every Monday at 8am UTC

  # Manual trigger
  workflow_dispatch:
    inputs:
      force_full_analysis:
        description: 'Force full analysis (ignore cache)'
        required: false
        default: false
        type: boolean

  # Trigger on manifest changes
  push:
    paths:
      - 'Cargo.toml'
      - 'package.json'
      - 'requirements.txt'
      - 'pyproject.toml'

  # Trigger when dependency PRs are merged
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  research-context:
    # Only run if:
    # - Scheduled/manual trigger
    # - Push to manifest files
    # - Dependency PR was merged (not just closed)
    if: >
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' &&
       github.event.pull_request.merged == true &&
       contains(github.event.pull_request.labels.*.name, 'dependencies'))

    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ¦€ Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ“¦ Cache Rust build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            tools/context-research-agent/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('tools/context-research-agent/Cargo.lock') }}

      - name: ğŸ”¨ Build Agent
        run: cargo build --release --manifest-path tools/context-research-agent/Cargo.toml

      - name: ğŸ“¦ Install gh-models extension
        run: gh extension install github/gh-models || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ§  Run Research Agent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ§  Running Context Research Agent with GitHub Models (GPT-4o-mini)..."
          echo "ğŸ“Š Using gh models run - FREE tier, no API key needed"
          echo "ğŸ“Š Strategy: 5 deps/batch, 2s delay between calls"
          ./tools/context-research-agent/target/release/context-research-agent \
            --output docs/agent-docs/RESEARCH_STACK_CONTEXT.md \
            --workspace .

      - name: ğŸ”€ Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(context): update living research context"
          title: "ğŸ§  Update Living Research Context"
          body: |
            ## ğŸ§  Context Update

            The **Context Research Agent** has analyzed the current stack and updated the living context document.

            ### ğŸ“ Changes
            - Updated `docs/agent-docs/RESEARCH_STACK_CONTEXT.md` with latest insights.

            ### ğŸ¤– AI Instructions
            This document is now the Single Source of Truth for:
            - Exact dependency versions
            - Known anomalies in these versions
            - Recommended implementation patterns

            *Auto-generated by Context Research Agent*
          branch: chore/update-context
          delete-branch: true
